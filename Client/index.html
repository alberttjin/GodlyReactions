<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
<script src="/socket.io/socket.io.js"></script>
<script></script>
</head>
<body onclick="setMousePos(event)">
<script>

var mainChar;
var enemy;
var enemyAttack;
var firstJoined = false;
var bmouseX = 10;
var bmouseY = 0;
var mouseX = 10;
var mouseY = 0;
var attack;
var setAttack = false;
var setEnemyAttack = false;
var attackExists = false;
var moving = false;
var background = new Image();
background.src = "sky.jpg";
var socket = io();

socket.on("updateAngle", function(data) {
    enemy.angle += data.rotation;
});
socket.on("updateEnemyChar", function(data) {
    console.log("updated2");
    moveEnemy(data.characterX, data.characterY);
});

socket.on("updateEnemyAttack", function(data) {
    setEnemyAttack = true;
    enemyAttack = new projectile(50, 25, "fireball.png", data.currX, data.currY, data.goalX, data.goalY);
});

socket.on("firstJoined", function(data){
    firstJoined = true;
});

socket.on("start", function(data) {
    startGame();
});

function startGame() {
    gameState.start();
    if (firstJoined) {
      mainChar = new character(50, 50, "dragon2.png", screen.width / 4, screen.height / 2);
      enemy = new character(50, 50, "dragon2.png", (screen.width * 3) / 4, screen.height / 2);
    } else {
      enemy = new character(50, 50, "dragon2.png", screen.width / 4, screen.height / 2);
      mainChar = new character(50, 50, "dragon2.png", (screen.width * 3) / 4, screen.height / 2);
    }
}

var gameState = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = screen.width;
        this.canvas.height = screen.height;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.interval = setInterval(updateGame, 0.5);
        window.addEventListener('keydown', function (e) {
          if (!attackExists) {
            fire();
          }
        })
        window.addEventListener('keyup', function (e) {
          gameState.key = false;
        })
        window.addEventListener('mousemove', function (e) {
          gameState.currX = e.clientX;
          gameState.currY = e.clientY;
        })
    }
}

function setMousePos(event) {
    var oldX = mouseX;
    var oldY = mouseY;
    mouseX = event.clientX;
    mouseY = event.clientY;
    rotateChar(oldX, oldY);
    moving = true;
}
function pythagorean(x1, y1, x2, y2) {
    var xDis = Math.pow((x1 - x2), 2);
    var yDis = Math.pow((y1 - y2), 2);
    return Math.sqrt(xDis + yDis);
}
function rotateChar(oldX, oldY) {
    var side1 = pythagorean(mouseX, mouseY, oldX, oldY);
    var side2 = pythagorean(mouseX, mouseY, mainChar.x, mainChar.y);
    var side3 = pythagorean(oldX, oldY, mainChar.x, mainChar.y);
    var numerator = Math.pow(side2, 2) + Math.pow(side3, 2) - Math.pow(side1, 2);
    var denominator = 2 * side2 * side3;
    var rotateAmount = Math.acos(numerator / denominator);
    if (checkNegative(oldX, oldY)) {
      rotateAmount *= -1;
    }
    mainChar.angle += rotateAmount;
    socket.emit("angle", {rotation: rotateAmount});
}
function checkNegative(x, y) {
    var slope = (y - mainChar.y) / (x - mainChar.x);
    var b = y - (slope * x);
    var result = (slope * mouseX) + b;
    if (x > mainChar.x) {
      return result > mouseY;
    } else {
      return result < mouseY;
    }
}

function moveChar() {
    if (moving) {
      var hypotenuse = pythagorean(mouseX, mouseY, mainChar.x, mainChar.y);
      var xMove = (mouseX - mainChar.x) / (hypotenuse * 1.5);
      var yMove = (mouseY - mainChar.y) / (hypotenuse * 1.5);
      mainChar.x += xMove;
      mainChar.y += yMove;
      updateServerChar(xMove, yMove);
    }
}

function moveEnemy(xMove, yMove) {
    enemy.x += xMove;
    enemy.y += yMove;
    console.log(xMove);
    console.log(yMove);
}

function updateBackground() {
    var ctx = gameState.context;
    ctx.drawImage(background, 0, 0, gameState.canvas.width, gameState.canvas.height);
}
function clearCanvas() {
    gameState.context.clearRect(0, 0, gameState.canvas.width, gameState.canvas.height);
}

function character(width, height, image, x, y) {
    this.width = width;
    this.height = height;
    this.x = x;
    this.y = y;
    this.angle = 0;
    this.charModel = new Image();
    this.charModel.src = image;
    this.update = function() {
      ctx = gameState.context;
      ctx.save();
      ctx.translate(this.x, this.y)
      ctx.rotate(this.angle);
      ctx.drawImage(this.charModel, this.width / -2, this.height / -2, this.width, this.height);
      ctx.restore();
    }
}

function projectile(width, height, image, x, y, goalx, goaly) {
    this.width = width;
    this.height = height;
    this.x = x;
    this.y = y;
    this.goalx = goalx;
    this.goaly = goaly;
    this.charModel = new Image();
    this.charModel.src = image;
    var xDis = Math.pow(this.goalx - this.x, 2);
    var yDis = Math.pow(this.goaly - this.y, 2);
    var hypotenuse = Math.sqrt(xDis + yDis);
    this.moveX = ((this.goalx - this.x) / hypotenuse) * 3;
    this.moveY = ((this.goaly - this.y) / hypotenuse) * 3;
    this.update = function() {
      this.x += this.moveX;
      this.y += this.moveY;
      ctx = gameState.context;
      ctx.drawImage(this.charModel, this.x, this.y, this.width, this.height);
    }
}

function fire() {
    setAttack = true;
    attackExists = true;
    updateServerAttack(mainChar.x, mainChar.y, gameState.currX, gameState.currY);
    attack = new projectile(50, 25, "fireball.png", mainChar.x, mainChar.y, gameState.currX, gameState.currY);
}

function checkStop() {
    return mainChar.x == mouseX && mainChar.y == mouseY;
}

function checkAttack() {
    if (attack.x > gameState.canvas.width || attack.x < 0 ||   attack.y > gameState.canvas.length || attack.y < 0) {
      attackExists = false;
    }
}
function checkEnemyAttack() {
    if (enemyAttack.x > gameState.canvas.width || enemyAttack.x < 0 ||  enemyAttack.y > gameState.canvas.length || enemyAttack.y < 0) {
      attackExists = false;
    }
}
function updateServerChar(changeX, changeY) {
    var updateContent = {
      characterX: changeX,
      characterY: changeY,
    }
    socket.emit("updateChar", updateContent);
}

function updateServerAttack(x, y, x2, y2) {
    var updateContent = {
      currX: x,
      currY: y,
      goalX: x2,
      goalY: y2
    }
    socket.emit("updateAttack", updateContent);
}

function updateGame() {
    clearCanvas();
    //checkStop();
    updateBackground();
    moveChar();
    if (setAttack) {
      checkAttack();
      attack.update();
    }
    if (setEnemyAttack) {
      checkEnemyAttack();
      enemyAttack.update();
    }
    mainChar.update();
    enemy.update();
}
</script>

</html>
